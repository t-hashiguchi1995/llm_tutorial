# **開発ガイドライン**

このドキュメントには、このコードベースで作業するための重要な情報が含まれています。これらのガイドラインに正確に従ってください。

## **コア開発ルール**

1. **パッケージ管理**  
   * **uvのみを使用**し、決してpipは使用しないでください。  
   * インストール: uv add package  
   * ツールの実行: uv run tool  
   * アップグレード: uv add \--dev package \--upgrade-package package  
   * **禁止**: uv pip install、@latest 構文  
2. **コード品質**  
   * すべてのコードに型ヒントが必須です。  
   * 公開APIにはdocstringが必要です。  
   * 関数は焦点を絞り、小さく保つ必要があります。  
   * 既存のパターンに厳密に従ってください。  
   * 行長: 最大88文字  
3. **テスト要件**  
   * フレームワーク: uv run \--frozen pytest  
   * 非同期テスト: asyncioではなく、anyioを使用してください。  
   * カバレッジ: エッジケースとエラーをテストしてください。  
   * 新機能にはテストが必要です。  
   * バグ修正にはリグレッションテストが必要です。  
* ユーザー報告に基づくバグ修正や機能追加のコミットには、以下を追加してください。  
  git commit \--trailer "Reported-by:\<name\>"

  ここで \<name\> はユーザー名です。  
* Github issueに関連するコミットには、以下を追加してください。  
  git commit \--trailer "Github-Issue:\#\<number\>"

* co-authored-by やそれに類する情報には**決して言及しないでください**。特に、コミットメッセージやPRの作成に使用したツールについては、決して言及しないでください。

## **プルリクエスト**

* 何が変更されたかについての詳細なメッセージを作成してください。解決しようとしている問題のハイレベルな説明と、その解決方法に焦点を当ててください。明確になる場合を除き、コードの詳細には立ち入らないでください。  
* レビュアーとして常に jerome3o-anthropic と jspahrsummers を追加してください。  
* co-authored-by やそれに類する情報には**決して言及しないでください**。特に、コミットメッセージやPRの作成に使用したツールについては、決して言及しないでください。

## **Pythonツール**

### **コードフォーマット**

1. **Ruff**  
   * フォーマット: uv run \--frozen ruff format .  
   * チェック: uv run \--frozen ruff check .  
   * 修正: uv run \--frozen ruff check . \--fix  
   * 重要な問題:  
     * 行長 (88文字)  
     * importのソート (I001)  
     * 未使用のimport  
   * 行の折り返し:  
     * 文字列: 括弧を使用  
     * 関数呼び出し: 適切なインデントで複数行に分割  
     * import: 複数行に分割  
2. **型チェック**  
   * ツール: uv run \--frozen pyright  
   * 要件:  
     * Optionalに対する明示的なNoneチェック  
     * 文字列に対する型の絞り込み  
     * チェックが通る場合、バージョンの警告は無視してかまいません  
3. **Pre-commit**  
   * 設定ファイル: .pre-commit-config.yaml  
   * 実行タイミング: git commit 時  
   * ツール: Prettier (YAML/JSON), Ruff (Python)  
   * Ruffの更新:  
     * PyPIのバージョンを確認する  
     * 設定ファイルのrevを更新する  
     * 最初に設定ファイルをコミットする

## **エラー解決**

1. **CIの失敗**  
   * 修正の順序:  
     1. フォーマット  
     2. 型エラー  
     3. リンティング  
   * 型エラー:  
     * 完全な行のコンテキストを取得する  
     * Optional型を確認する  
     * 型の絞り込みを追加する  
     * 関数シグネチャを検証する  
2. **よくある問題**  
   * 行長:  
     * 括弧を使って文字列を分割する  
     * 関数呼び出しを複数行にする  
     * importを分割する  
   * 型:  
     * Noneチェックを追加する  
     * 文字列の型を絞り込む  
     * 既存のパターンに合わせる  
   * Pytest:  
     * テストがanyioのpytestマークを見つけられない場合は、pytest実行コマンドの先頭に PYTEST\_DISABLE\_PLUGIN\_AUTOLOAD="" を追加してみてください。例:  
       PYTEST\_DISABLE\_PLUGIN\_AUTOLOAD="" uv run \--frozen pytest  
3. **ベストプラクティス**  
   * コミット前にgit statusを確認する  
   * 型チェックの前にフォーマッターを実行する  
   * 変更は最小限に抑える  
   * 既存のパターンに従う  
   * 公開APIを文書化する  
   * 徹底的にテストする